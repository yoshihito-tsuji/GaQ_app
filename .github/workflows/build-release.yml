# GaQ Offline Transcriber - ãƒ“ãƒ«ãƒ‰ï¼†ãƒªãƒªãƒ¼ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
#
# ãƒˆãƒªã‚¬ãƒ¼:
#   - æ‰‹å‹•å®Ÿè¡Œï¼ˆworkflow_dispatchï¼‰
#   - ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆv*ï¼‰
#
# ã‚¿ã‚°é‹ç”¨:
#   - v1.2.0 â†’ Macç‰ˆãƒ»Windowsç‰ˆã®ä¸¡æ–¹ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦Releaseæ·»ä»˜
#
# å¿…è¦ãªSecrets:
#   - APPLE_DEVELOPER_ID_CERT_BASE64: Developer IDè¨¼æ˜æ›¸ï¼ˆ.p12ã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
#   - APPLE_DEVELOPER_ID_CERT_PASSWORD: è¨¼æ˜æ›¸ã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º
#   - APPLE_ID: Apple IDï¼ˆå…¬è¨¼ç”¨ï¼‰
#   - APPLE_TEAM_ID: Apple Developer Team ID
#   - APPLE_APP_SPECIFIC_PASSWORD: Appå›ºæœ‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå…¬è¨¼ç”¨ï¼‰

name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.2.0)'
        required: true
        default: '1.1.1'
      skip_notarization:
        description: 'Skip macOS notarization'
        required: false
        type: boolean
        default: false

  push:
    tags:
      - 'v*'

env:
  PYTHON_VERSION: '3.12.x'  # 3.12ç³»ã®æœ€æ–°ãƒ‘ãƒƒãƒã‚’ä½¿ç”¨

permissions:
  contents: write

jobs:
  # ========================================
  # macOS ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  # ========================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    outputs:
      dmg_name: ${{ steps.build.outputs.dmg_name }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # ã‚¿ã‚°ã‹ã‚‰ v ã‚’é™¤å»
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: release/mac
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt
          pip install pyinstaller Pillow

      - name: Update version in build script
        working-directory: release/mac
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # DMGåã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          sed -i '' "s/DMG_NAME=\"GaQ_Transcriber_v.*_mac.dmg\"/DMG_NAME=\"GaQ_Transcriber_v${VERSION}_mac.dmg\"/" build.sh
          # ãƒœãƒªãƒ¥ãƒ¼ãƒ åã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          sed -i '' "s/-volname \"\$APP_NAME v.*\"/-volname \"\$APP_NAME v${VERSION}\"/" build.sh

      - name: Import Developer ID certificate
        if: ${{ github.event.inputs.skip_notarization != 'true' }}
        env:
          DEVELOPER_ID_CERT_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_CERT_BASE64 }}
          DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          # ä¸€æ™‚Keychainã‚’ä½œæˆ
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # è¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          echo "$DEVELOPER_ID_CERT_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$DEVELOPER_ID_CERT_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Keychainã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
          security list-keychain -d user -s "$KEYCHAIN_PATH" login.keychain
          security default-keychain -s "$KEYCHAIN_PATH"

          # ã‚³ãƒ¼ãƒ‰ç½²åã®è¨±å¯
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # è¨¼æ˜æ›¸ã‚’ç¢ºèª
          echo "Available signing identities:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

          # è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f $RUNNER_TEMP/certificate.p12

      - name: Store notarization credentials
        if: ${{ github.event.inputs.skip_notarization != 'true' }}
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          xcrun notarytool store-credentials "notarytool" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD"

      - name: Build with signing and notarization
        id: build
        working-directory: release/mac
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          DMG_NAME_VERSIONED="GaQ_Transcriber_v${VERSION}_mac.dmg"
          DMG_NAME_LATEST="GaQ_Transcriber_macOS.dmg"

          SKIP_NOTARIZE="${{ github.event.inputs.skip_notarization }}"
          echo "skip_notarization value: $SKIP_NOTARIZE"

          if [ "$SKIP_NOTARIZE" = "true" ]; then
            echo "Building without signing/notarization..."
            ./build.sh
          else
            echo "Building with signing and notarization..."
            ./build.sh --notarize
          fi

          # å›ºå®šåã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆï¼ˆlatest URLç”¨ï¼‰
          if [ -f "dist/$DMG_NAME_VERSIONED" ]; then
            cp "dist/$DMG_NAME_VERSIONED" "dist/$DMG_NAME_LATEST"
            # SHA256ã‚‚ä½œæˆ
            cd dist && shasum -a 256 "$DMG_NAME_LATEST" > "${DMG_NAME_LATEST}.sha256" && cd ..
          fi

          echo "dmg_name=$DMG_NAME_VERSIONED" >> $GITHUB_OUTPUT
          echo "dmg_name_latest=$DMG_NAME_LATEST" >> $GITHUB_OUTPUT

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: |
            release/mac/dist/*.dmg
            release/mac/dist/*.sha256
          retention-days: 7

      - name: Cleanup Keychain
        if: always()
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH" || true
          fi

  # ========================================
  # Windows ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  # ========================================
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    outputs:
      zip_name: ${{ steps.build.outputs.zip_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: release/windows
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt
          pip install pyinstaller

      - name: Verify webview installation
        shell: pwsh
        run: |
          Write-Host "=== Python Environment Check ==="
          python -c "import sys; print(f'Python: {sys.version}')"
          python -c "import struct, platform; print(f'Architecture: {struct.calcsize(\"P\")*8}bit, Machine: {platform.machine()}')"

          Write-Host ""
          Write-Host "=== webview Package Check ==="
          python -c "import webview; print(f'webview version: {getattr(webview, \"__version__\", \"unknown\")}')"
          python -c "import webview; print(f'webview location: {webview.__file__}')"
          python -c "import webview; from pathlib import Path; p = Path(webview.__file__).parent / 'platforms'; print(f'platforms exists: {p.exists()}'); print(f'platforms contents: {list(p.glob(\"*\")) if p.exists() else \"N/A\"}')"

          Write-Host ""
          Write-Host "=== pythonnet/clr Check ==="
          python -c "import clr_loader; print(f'clr_loader version: {getattr(clr_loader, \"__version__\", \"unknown\")}')"
          python -c "import pythonnet; print(f'pythonnet location: {pythonnet.__file__}')"

          Write-Host ""
          Write-Host "=== pip freeze ==="
          pip freeze | Select-String -Pattern "webview|pythonnet|clr"

      - name: Build with PyInstaller
        id: build
        working-directory: release/windows
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $ZIP_NAME_VERSIONED = "GaQ_Transcriber_Windows_v${VERSION}_Portable.zip"
          $ZIP_NAME_LATEST = "GaQ_Transcriber_Windows.zip"

          # PyInstallerã§ãƒ“ãƒ«ãƒ‰ï¼ˆDEBUGãƒ­ã‚°æœ‰åŠ¹ï¼‰
          Write-Host "=== Starting PyInstaller build ==="
          pyinstaller --clean -y --log-level DEBUG GaQ_Transcriber.spec 2>&1 | Tee-Object -FilePath "build_log.txt"

          # ãƒ“ãƒ«ãƒ‰çµæœç¢ºèª
          if (-not (Test-Path "dist\GaQ_Transcriber\GaQ_Transcriber.exe")) {
            Write-Host "FATAL: GaQ_Transcriber.exe not found!"
            exit 1
          }

          # ZIPã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ãï¼‰
          Compress-Archive -Path "dist\GaQ_Transcriber\*" -DestinationPath "dist\$ZIP_NAME_VERSIONED" -Force

          # SHA256ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ãï¼‰
          $hash = (Get-FileHash "dist\$ZIP_NAME_VERSIONED" -Algorithm SHA256).Hash
          "$hash  $ZIP_NAME_VERSIONED" | Out-File -FilePath "dist\${ZIP_NAME_VERSIONED}.sha256" -Encoding ASCII

          # å›ºå®šåã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆï¼ˆlatest URLç”¨ï¼‰
          Copy-Item "dist\$ZIP_NAME_VERSIONED" "dist\$ZIP_NAME_LATEST"
          $hashLatest = (Get-FileHash "dist\$ZIP_NAME_LATEST" -Algorithm SHA256).Hash
          "$hashLatest  $ZIP_NAME_LATEST" | Out-File -FilePath "dist\${ZIP_NAME_LATEST}.sha256" -Encoding ASCII

          echo "zip_name=$ZIP_NAME_VERSIONED" >> $env:GITHUB_OUTPUT
          echo "zip_name_latest=$ZIP_NAME_LATEST" >> $env:GITHUB_OUTPUT

          # æˆæœç‰©ã®ç¢ºèª
          Write-Host "Built artifacts:"
          Get-ChildItem dist\*.zip, dist\*.sha256

      - name: Verify build artifacts
        working-directory: release/windows
        shell: pwsh
        run: |
          Write-Host "=== Verifying build artifacts ==="

          Write-Host ""
          Write-Host "=== webview/platforms in dist ==="
          if (Test-Path "dist\GaQ_Transcriber\_internal\webview\platforms") {
            Get-ChildItem "dist\GaQ_Transcriber\_internal\webview\platforms" -Recurse
          } else {
            Write-Host "WARNING: webview/platforms not found in dist!"
            # ä»£æ›¿ãƒ‘ã‚¹ã‚’ç¢ºèª
            Write-Host "Searching for winforms.py..."
            Get-ChildItem "dist\GaQ_Transcriber\_internal" -Recurse -Filter "winforms.py" -ErrorAction SilentlyContinue
          }

          Write-Host ""
          Write-Host "=== pythonnet in dist ==="
          if (Test-Path "dist\GaQ_Transcriber\_internal\pythonnet") {
            Get-ChildItem "dist\GaQ_Transcriber\_internal\pythonnet" -Recurse
          } else {
            Write-Host "Searching for pythonnet files..."
            Get-ChildItem "dist\GaQ_Transcriber\_internal" -Recurse -Filter "*pythonnet*" -ErrorAction SilentlyContinue
            Get-ChildItem "dist\GaQ_Transcriber\_internal" -Recurse -Filter "Python.Runtime.dll" -ErrorAction SilentlyContinue
          }

          Write-Host ""
          Write-Host "=== pip freeze ==="
          pip freeze

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-build-log
          path: release/windows/build_log.txt
          retention-days: 7

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: |
            release/windows/dist/*.zip
            release/windows/dist/*.sha256
          retention-days: 7

  # ========================================
  # GitHub Release ä½œæˆã‚¸ãƒ§ãƒ–
  # ========================================
  create-release:
    name: Create Release
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: artifacts/macos

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-zip
          path: artifacts/windows

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: List artifacts
        run: |
          echo "=== macOS artifacts ==="
          ls -la artifacts/macos/ || echo "No macOS artifacts"
          echo ""
          echo "=== Windows artifacts ==="
          ls -la artifacts/windows/ || echo "No Windows artifacts"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat << 'EOF' > release_notes.md
          ## GaQ Offline Transcriber v${{ steps.version.outputs.version }}

          ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§å‹•ä½œã™ã‚‹AIæ–‡å­—èµ·ã“ã—ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

          #### macOSç‰ˆ
          - `GaQ_Transcriber_v${{ steps.version.outputs.version }}_mac.dmg` - macOS 10.15ä»¥é™å¯¾å¿œ
          - ç½²åãƒ»å…¬è¨¼æ¸ˆã¿ï¼ˆGatekeeperã§è­¦å‘Šãªã—ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¯èƒ½ï¼‰

          #### Windowsç‰ˆ
          - `GaQ_Transcriber_Windows_v${{ steps.version.outputs.version }}_Portable.zip` - Windows 10/11å¯¾å¿œ
          - ZIPã‚’è§£å‡ã—ã¦ `GaQ_Transcriber.exe` ã‚’å®Ÿè¡Œ

          ### ğŸ”’ ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
          å„ãƒ•ã‚¡ã‚¤ãƒ«ã®SHA256ãƒãƒƒã‚·ãƒ¥ã¯ `.sha256` ãƒ•ã‚¡ã‚¤ãƒ«ã§ç¢ºèªã§ãã¾ã™ã€‚

          ### ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶
          - **RAM**: 8GBä»¥ä¸Šæ¨å¥¨
          - **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 3GBä»¥ä¸Šï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
          - åˆå›èµ·å‹•æ™‚ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰

          ### ğŸ”§ ä¸»ãªæ©Ÿèƒ½
          - faster-whisperã«ã‚ˆã‚‹é«˜ç²¾åº¦æ–‡å­—èµ·ã“ã—
          - Medium/Large-v3ãƒ¢ãƒ‡ãƒ«å¯¾å¿œ
          - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤º
          - å®Œå…¨ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å‹•ä½œï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œï¼‰

          ---
          **é–‹ç™ºå…ƒ**: [å…¬ç«‹ã¯ã“ã ã¦æœªæ¥å¤§å­¦ è¾»ç ”ç©¶å®¤](https://tsuji-lab.net)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: GaQ Offline Transcriber v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: true
          prerelease: false
          files: |
            artifacts/macos/*
            artifacts/windows/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
