# Mac版 v1.1.1 リリース作業ログ

**作業日時**: 2025-10-16
**担当**: Claude Code
**目的**:
1. Mac版起動エラー修正とPython 3.12固定ビルドを正式リリース（v1.1.1）として反映
2. DMGセットアップ手順の簡略化とユーザビリティ向上

---

## 背景

### v1.1.0からv1.1.1への変更理由

**発生した問題（2025-10-16）**:
1. Mac版アプリが起動しない（Python 3.13.5互換性問題）
2. FastAPI type annotation構文エラー
3. build.shの改行コード問題（CRLF）

**実施した修正**:
1. FastAPI型アノテーション修正（`Annotated[UploadFile, File()]` → `UploadFile = File(...)`）
2. Python 3.12.12固定ビルド対応
3. build.shの改行コードをLFに修正
4. .gitattributes作成による改行コード管理

**v1.1.1としてリリースする理由**:
- 起動不具合修正は重要なバグフィックス
- Python 3.12への固定は互換性維持のための重要な変更
- ユーザーに影響する変更のため、パッチバージョンアップが適切

---

## 作業手順

### Phase 1: バージョン文字列の更新

**実施内容**:
1. [release/mac/GaQ_Transcriber.spec](../../release/mac/GaQ_Transcriber.spec)
   - CFBundleShortVersionString: 1.1.0 → 1.1.1
   - CFBundleVersion: 1.1.0 → 1.1.1

2. [README.md](../../README.md)
   - タイトルを両バージョン併記に変更
   - バージョン情報をMac v1.1.1 / Windows v1.1.0に更新
   - 配布パッケージ情報を更新

**結果**: ✅ 完了

---

### Phase 2: DMG内配置ファイルの作成

**作成したファイル**:

1. [release/mac/dmg_assets/インストール方法.txt](../../release/mac/dmg_assets/インストール方法.txt)
   - 詳細なインストール手順
   - Gatekeeper警告への対処方法（2種類）
   - xattrコマンドの使用方法
   - v1.1.1の変更履歴

2. [release/mac/dmg_assets/GaQ セットアップ.command](../../release/mac/dmg_assets/GaQ セットアップ.command)
   - 自動インストールスクリプト
   - アプリケーションフォルダへのコピー
   - Quarantine属性の自動削除（sudo使用）
   - 実行権限: 755

**効果**:
- ユーザーがインストール手順で迷わない
- Gatekeeperエラーを簡単に回避可能
- セットアップスクリプトでワンクリックインストール

**結果**: ✅ 完了

---

### Phase 3: build.shのDMG自動生成対応

**実施内容**:

[release/mac/build.sh](../../release/mac/build.sh)に以下を追加:
- ステップ5: DMGパッケージ作成
- DMG名: `GaQ_Transcriber_v1.1.1_mac.dmg`
- 一時ディレクトリ作成とファイル配置
- DMG内容:
  - GaQ Offline Transcriber.app
  - インストール方法.txt
  - GaQ セットアップ.command
  - Applications フォルダへのシンボリックリンク
- hdiutilでUDZO形式（圧縮）DMG作成

**コマンド**:
```bash
hdiutil create \
    -volname "GaQ Offline Transcriber v1.1.1" \
    -srcfolder "$DMG_TEMP_DIR" \
    -ov \
    -format UDZO \
    "dist/$DMG_NAME"
```

**結果**: ✅ 完了

---

### Phase 4: HISTORY.mdの更新

**実施内容**:

[docs/HISTORY.md](../HISTORY.md)の先頭にv1.1.1エントリを追加:
- リリース概要
- 4つの主要な変更内容
- 配布パッケージ情報
- 技術詳細
- ドキュメントリンク
- 変更ファイル一覧

**結果**: ✅ 完了

---

## 作業結果まとめ

### 完了した作業

| 項目 | 内容 | ステータス |
|------|------|----------|
| バージョン更新 | Mac版主要ファイルを1.1.1に更新 | ✅ 完了 |
| インストールガイド | DMG内配置用テキストファイル作成 | ✅ 完了 |
| セットアップスクリプト | 自動インストールスクリプト作成 | ✅ 完了 |
| build.sh改修 | DMG自動生成機能を追加 | ✅ 完了 |
| HISTORY.md更新 | v1.1.1エントリを追加 | ✅ 完了 |
| 開発ログ作成 | 本ファイル | ✅ 完了 |

### Phase 5: ビルド実行と検証

**実施内容**:

1. **ビルド実行**:
   ```bash
   cd release/mac
   ./build.sh 2>&1 | tee build_output.log
   ```

   **ビルド結果**:
   - Python 3.12.12使用 ✓
   - PyInstaller 6.16.0 ✓
   - ビルド時間: 約20秒
   - 警告: Hidden import 'python_multipart' not found（非クリティカル）
   - 終了コード: 0（成功）

2. **成果物サイズ**:
   ```
   dist/GaQ Offline Transcriber.app - 187M
   dist/GaQ_Transcriber_v1.1.1_mac.dmg - 77M
   ```

3. **DMG内容検証（第1回）**:
   - DMGマウント成功 ✓
   - 必要ファイルの存在確認:
     - `GaQ Offline Transcriber.app` ✓
     - `インストール方法.txt` ✓
     - `GaQ セットアップ.command` ✓
     - `Applications` シンボリックリンク ✓
   - **問題発見**: セットアップスクリプトがCRLF改行だった

4. **改行コード修正と再ビルド**:
   ```bash
   sed -i '' 's/\r$//' "dmg_assets/GaQ セットアップ.command"
   ```
   - `.gitattributes`に `*.command text eol=lf` を追加
   - DMGのみ再作成（アプリは再ビルド不要）

5. **DMG内容検証（第2回）**:
   - `GaQ セットアップ.command`: LF改行 ✓
   - ファイルサイズ: 3479バイト（CRLF版: 3578バイト）
   - 実行権限: 755 ✓
   - 全ファイル確認完了 ✓

6. **アプリ起動テスト**:
   ```bash
   open "dist/GaQ Offline Transcriber.app"
   ```
   - プロセス起動確認: PID 48195 ✓
   - HTTPサーバー起動: http://127.0.0.1:8000 ✓
   - ヘルスチェック: `{"status":"ok","service":"GaQ Transcription API"}` ✓
   - 起動エラーなし ✓

**結果**: ✅ 完了

---

## Phase 6: 改行コード修正の追記録

### 発見した問題

DMG検証時に`GaQ セットアップ.command`がCRLF改行であることが判明。

### 原因

- Write toolで作成したファイルがCRLFで保存された
- `.gitattributes`に`.command`拡張子の設定がなかった

### 修正内容

1. **ソースファイルの改行変換**:
   ```bash
   sed -i '' 's/\r$//' "release/mac/dmg_assets/GaQ セットアップ.command"
   ```

2. **`.gitattributes`の更新**:
   ```gitattributes
   *.command text eol=lf
   ```

3. **DMG再作成**:
   - アプリは再ビルド不要（187M、変更なし）
   - DMGのみ再生成（77M）

### 検証結果

```bash
file "/Volumes/GaQ_Transcriber_v1.1.1/GaQ セットアップ.command"
# 出力: Bourne-Again shell script text executable, Unicode text, UTF-8 text
```

CRLF表記が消え、LF改行であることを確認。

**結果**: ✅ 修正完了

---

## 変更ファイル一覧

### 新規作成

```
release/mac/dmg_assets/インストール方法.txt
release/mac/dmg_assets/GaQ セットアップ.command
docs/development/20251016_mac_v1.1.1_release.md (本ファイル)
```

### 修正

```
README.md
release/mac/GaQ_Transcriber.spec
release/mac/build.sh
docs/HISTORY.md
.gitattributes (*.command text eol=lf 追加)
release/mac/dmg_assets/GaQ セットアップ.command (CRLF → LF)
```

---

## 技術メモ

### DMG作成のポイント

1. **Applicationsリンク**:
   - シンボリックリンク作成で、ユーザーがドラッグ&ドロップしやすい
   - `ln -s /Applications "$DMG_TEMP_DIR/Applications"`

2. **圧縮形式**:
   - UDZO形式: 最高圧縮率
   - ファイルサイズ削減に有効

3. **ボリューム名**:
   - バージョン番号を含めることで識別しやすい
   - マウント時に表示される名前

### インストール手順のユーザビリティ

**良い点**:
- 2つの方法を提供（手動/自動）
- xattrコマンドをコピー可能な形式で掲載
- 警告画面のスクリーンショットは不要（テキストで十分）

**改善の余地**:
- スクリーンショット追加（将来的に検討）
- 動画チュートリアル（必要性は低い）

---

## まとめ

### 達成内容

✅ Mac版v1.1.1リリース準備が完了
✅ DMGセットアップの大幅な簡略化
✅ ユーザビリティの向上
✅ ビルドプロセスの自動化
✅ ビルド実行完了（Python 3.12.12、PyInstaller 6.16.0）
✅ DMG作成完了（77M、圧縮済み）
✅ DMG内容検証完了（全ファイル確認、改行コード修正済み）
✅ アプリ起動テスト完了（正常起動、サーバー応答確認）

### 品質保証

- バージョン番号の一貫性: ✅ 確認済み
- ファイル権限: ✅ セットアップスクリプトに付与済み
- 改行コード: ✅ .gitattributesで管理（*.sh、*.command）
- ドキュメント: ✅ 包括的に記録
- ビルド成果物: ✅ 検証完了
- アプリ起動: ✅ 動作確認済み

### 最終成果物

```
release/mac/dist/
├── GaQ Offline Transcriber.app (187M)
└── GaQ_Transcriber_v1.1.1_mac.dmg (77M)
    ├── GaQ Offline Transcriber.app
    ├── インストール方法.txt
    ├── GaQ セットアップ.command (LF改行、実行権限付き)
    └── Applications -> /Applications
```

### 残作業

1. コミット＆push（修正ファイル: .gitattributes、GaQ セットアップ.command、開発ログ）
2. サーバーへのアップロード（別途実施）

---

## Phase 7: バージョン表示の復活

**作業日時**: 2025-10-16 21:35
**担当**: Claude Code
**目的**: アプリ起動時にバージョン（v1.1.1）が表示されるよう修正し、API/ログでもバージョンを参照可能にする

### 背景

現状、アプリのウィンドウタイトルやログにバージョン情報が表示されていない。ユーザーがどのバージョンを使用しているか確認できるよう、以下の箇所にバージョン表示を追加する必要がある:
- ウィンドウタイトル
- 起動・終了ログ
- フロントエンドHTML（タイトル、ヘッダ、クレジット）
- `/health` APIレスポンス

### 実施内容

#### 1. config.pyにバージョン定数を追加

[release/mac/src/config.py](../../release/mac/src/config.py)に以下を追加:
```python
# アプリケーションバージョン
APP_VERSION = "v1.1.1"
```

**位置**: faster-whisperモデル設定とサーバー設定の間（21-22行目）

**結果**: ✅ 完了

#### 2. main_app.pyのウィンドウタイトルとログにバージョンを追加

**変更ファイル**: [release/mac/src/main_app.py](../../release/mac/src/main_app.py)

**変更内容**:
- `from config import APP_VERSION` をインポート追加（18行目）
- ウィンドウタイトル: `title=f"GaQ Offline Transcriber {APP_VERSION}"` (100行目)
- 起動ログ: `logger.info(f"=== GaQ Offline Transcriber {APP_VERSION} 起動 ===")` (117行目)
- 終了ログ: `logger.info(f"=== GaQ Offline Transcriber {APP_VERSION} 終了 ===")` (132行目)

**結果**: ✅ 完了

#### 3. main.pyのフロントエンド表示にバージョンを追加

**変更ファイル**: [release/mac/src/main.py](../../release/mac/src/main.py)

**変更内容**:
- `from config import APP_VERSION` をインポートに追加（15行目）
- HTMLタイトルタグ: `<title>GaQ Offline Transcriber {version} - オフラインAI文字おこし</title>` (70行目)
- h1タグ: `GaQ Offline Transcriber {version}` (413行目)
- `.format(version=APP_VERSION)` でHTML文字列に変数を注入（909行目）

**技術詳細**:
- JavaScript内に`{}`が多数あるため、f-stringではなく`.format()`を使用
- これによりJavaScriptコードの`{}`をエスケープする必要がなくなった

**結果**: ✅ 完了

#### 4. /healthエンドポイントにバージョン情報を追加

**変更ファイル**: [release/mac/src/main.py](../../release/mac/src/main.py)

**変更内容**:
```python
@app.get("/health")
async def health_check():
    """ヘルスチェック"""
    return {"status": "ok", "service": "GaQ Transcription API", "version": APP_VERSION}
```

**レスポンス例**:
```json
{
  "status": "ok",
  "service": "GaQ Transcription API",
  "version": "v1.1.1"
}
```

**結果**: ✅ 完了

#### 5. 構文チェック実行

```bash
python3 -m compileall release/mac/src
```

**結果**: ✅ 構文エラーなし

**注意**: 初回はf-string使用時にJavaScriptの`{}`がエラーになったが、`.format()`に変更して解決

### 確認結果

| 項目 | 確認方法 | 結果 |
|------|---------|------|
| config.py | ファイル読み込み確認 | ✅ APP_VERSION = "v1.1.1" 追加 |
| main_app.py | インポートとf-string確認 | ✅ ウィンドウタイトル・ログにバージョン追加 |
| main.py | HTML内容とヘルスエンドポイント確認 | ✅ タイトル・h1・APIレスポンスにバージョン追加 |
| 構文チェック | compileall実行 | ✅ エラーなし |
| git差分 | git status確認 | ✅ 3ファイル変更（config.py, main.py, main_app.py） |

### バージョン表示箇所まとめ

**実装完了**:
1. ウィンドウタイトル: `GaQ Offline Transcriber v1.1.1`
2. 起動ログ: `=== GaQ Offline Transcriber v1.1.1 起動 ===`
3. 終了ログ: `=== GaQ Offline Transcriber v1.1.1 終了 ===`
4. HTMLタイトル: `GaQ Offline Transcriber v1.1.1 - オフラインAI文字おこし`
5. HTMLヘッダ: `GaQ Offline Transcriber v1.1.1`
6. /health API: `{"status": "ok", "service": "GaQ Transcription API", "version": "v1.1.1"}`

### 残課題

- 実機起動テストは未実施（ビルド不要、ソースレベルの変更のみのため次回ビルド時に確認）
- ウィンドウタイトルとHTMLヘッダにバージョンが表示されることを次回起動時に目視確認

**結果**: ✅ Phase 7 完了

---

**最終更新**: 2025-10-16
**ステータス**: ✅ v1.1.1ビルド＆検証完了 + バージョン表示機能追加完了
