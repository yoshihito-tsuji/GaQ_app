# 性能計測ガイド - Xcode Instruments活用法

**対象**: iOS版GaQ Transcriber の性能検証
**作成日**: 2025-10-23
**担当**: Claude Code
**対象者**: Yoshihitoさん（初心者向け）

---

## 📋 目次

1. [性能計測の目的](#性能計測の目的)
2. [Xcode Instrumentsとは](#xcode-instrumentsとは)
3. [計測手順](#計測手順)
4. [10分音声テストの記録テンプレート](#10分音声テストの記録テンプレート)
5. [計測結果の共有形式](#計測結果の共有形式)
6. [トラブルシューティング](#トラブルシューティング)

---

## 性能計測の目的

### Phase 1で検証すべき項目

iOS版GaQ Transcriberの**10分音声文字起こし**において、以下の性能指標を測定します。

| 指標 | 目標値 | 重要度 |
|------|--------|--------|
| **レイテンシ** | 1分以内 | 🔴 高 |
| **メモリ使用量** | 500MB以下 | 🔴 高 |
| **CPU使用率** | 平均50%以下 | 🟡 中 |
| **発熱** | 「温かい」程度 | 🟡 中 |
| **バッテリー消費** | 5%以下 | 🟢 低 |

### なぜ計測が必要か

**理由1: ユーザー体験の保証**
- 処理が遅すぎると実用性が低下
- 発熱がひどいとiPhoneが使えなくなる

**理由2: モデル選定の根拠**
- Base vs Smallの比較
- 量子化モデル（INT8）の効果確認

**理由3: 開発方針の決定**
- 「10分音声が実用的か」の判断材料
- Phase 2での最適化の必要性を判断

---

## Xcode Instrumentsとは

### 概要

**Xcode Instruments**は、iOSアプリのパフォーマンス分析ツールです。

**主な機能**:
- **CPU使用率**の可視化
- **メモリ使用量**のリアルタイム監視
- **エネルギー消費**の計測
- **ネットワーク通信**の分析

### Instrumentsの起動方法

**方法1: Xcodeメニューから**
1. Xcodeでプロジェクトを開く
2. メニューバー「**Product**」→「**Profile**」（または`⌘I`）
3. Instrumentsが起動し、テンプレート選択画面が表示される

**方法2: アプリケーションから直接**
1. Launchpadから「Instruments」を検索
2. アプリを直接起動

![Instruments起動](https://via.placeholder.com/600x400?text=Instruments+%E8%B5%B7%E5%8B%95)

---

## 計測手順

### 事前準備

#### 1. 計測用音声ファイルの準備

**要件**:
- **形式**: M4A、MP3、WAV（iOSがサポートする形式）
- **長さ**: 10分前後（8-12分でOK）
- **内容**: 日本語、明瞭な発音
- **サンプル**: [sample_audio/README.md](sample_audio/README.md)を参照

**ファイルの配置**:
1. iPhoneを Mac に接続
2. Finderで「**iPhone**」→「**ファイル**」→「**WhisperKitSample**」（アプリ名）
3. 音声ファイルをドラッグ&ドロップ

#### 2. iPhoneの初期状態確認

**計測前のチェックリスト**:
- [ ] **バッテリー**: 80%以上（充電しながらの計測は避ける）
- [ ] **バックグラウンドアプリ**: すべて終了
- [ ] **低電力モード**: オフ
- [ ] **機内モード**: オン（通信の影響を排除）
- [ ] **明るさ**: 50%固定
- [ ] **温度**: 常温（冷えた状態から開始）

**バックグラウンドアプリの終了方法**:
1. iPhoneのホームボタンを2回押す（またはジェスチャー）
2. すべてのアプリを上にスワイプして終了

---

### 手順1: Time Profiler（CPU使用率）

**目的**: CPU使用率を計測し、処理負荷を把握

#### 操作手順

1. Xcodeで「**Product**」→「**Profile**」（`⌘I`）
2. テンプレート選択画面で「**Time Profiler**」を選択
3. 右上の「**Choose**」をクリック
4. ターゲットデバイスとして「**接続したiPhone**」を選択
5. 「**Record**」ボタン（●）をクリック

**アプリでの操作**:
1. 音声ファイルを選択
2. 「文字起こし開始」ボタンをタップ
3. 処理が完了するまで待機

**計測の停止**:
1. 文字起こし完了後、Instruments の「**Stop**」ボタンをクリック

#### 結果の確認

**CPU使用率グラフ**:
```
CPU使用率 (%)
100 |     ████████████
    |    █            █
 50 |   █              █
    |  █                █
  0 |██                  ██
    +----------------------
      0  10  20  30  40  50 (秒)
```

**記録する値**:
- **平均CPU使用率**: グラフ下部に表示（例: 45%）
- **ピークCPU使用率**: グラフの最高値（例: 95%）

**スクリーンショット保存**:
1. `⌘⇧4`でスクリーンショット
2. ファイル名: `cpu_base_10min_iphone14.png`

---

### 手順2: Allocations（メモリ使用量）

**目的**: メモリ使用量を計測し、メモリリークがないか確認

#### 操作手順

1. Xcodeで「**Product**」→「**Profile**」（`⌘I`）
2. テンプレート選択画面で「**Allocations**」を選択
3. 「**Record**」ボタンをクリック
4. アプリで文字起こしを実行
5. 完了後、「**Stop**」ボタンをクリック

#### 結果の確認

**メモリ使用量グラフ**:
```
メモリ (MB)
800 |           ████████
    |         ██        ██
400 |       ██            ██
    |     ██                ██
  0 |█████                    ████
    +---------------------------
      0   10   20   30   40   50 (秒)
```

**記録する値**:
- **ピークメモリ使用量**: グラフの最高値（例: 650MB）
- **平均メモリ使用量**: グラフ全体の平均（例: 500MB）

**重要な確認ポイント**:
- 処理完了後、メモリが**元のレベルに戻る**か？
  - ✅ 戻る → メモリリークなし
  - ❌ 戻らない → メモリリークの可能性

**スクリーンショット保存**:
1. `⌘⇧4`でスクリーンショット
2. ファイル名: `memory_base_10min_iphone14.png`

---

### 手順3: Energy Log（エネルギー消費）

**目的**: バッテリー消費を計測

#### 操作手順

1. Xcodeで「**Product**」→「**Profile**」（`⌘I`）
2. テンプレート選択画面で「**Energy Log**」を選択
3. 「**Record**」ボタンをクリック
4. アプリで文字起こしを実行
5. 完了後、「**Stop**」ボタンをクリック

#### 結果の確認

**エネルギーグラフ**:
```
Energy Impact
High   |     ████
       |    █    █
Medium |   █      █
       |  █        █
Low    |██          ██
       +----------------
         0  10  20  30 (秒)
```

**記録する値**:
- **Energy Impact**: Low / Medium / High のどれか
- **推定バッテリー消費**: グラフ下部に表示（例: 3%）

**スクリーンショット保存**:
1. `⌘⇧4`でスクリーンショット
2. ファイル名: `energy_base_10min_iphone14.png`

---

### 手順4: 発熱の主観評価

**目的**: iPhoneの発熱を体感で確認

#### 評価基準

| レベル | 説明 | 判定 |
|--------|------|------|
| **冷たい** | 処理前と変わらない | ✅ 合格 |
| **温かい** | ほんのり温かい | ✅ 合格 |
| **熱い** | 手で持つと熱を感じる | ⚠️ 注意 |
| **非常に熱い** | 持ち続けるのが困難 | ❌ 不合格 |

#### 記録方法

**テンプレート**:
```
発熱レベル: 温かい
コメント: 処理開始30秒後から温かくなり始めたが、持ち続けられるレベル。
         処理完了後1分で常温に戻った。
```

---

### 手順5: レイテンシ（処理時間）

**目的**: 文字起こし開始から完了までの時間を計測

#### 計測方法

**方法1: アプリ内タイマー（推奨）**

アプリにタイマー機能を実装:
```swift
import Foundation

struct TranscriptionTimer {
    private var startTime: Date?

    mutating func start() {
        startTime = Date()
    }

    func elapsed() -> TimeInterval {
        guard let start = startTime else { return 0 }
        return Date().timeIntervalSince(start)
    }
}

// 使用例
var timer = TranscriptionTimer()
timer.start()

// 文字起こし実行...

let elapsedSeconds = timer.elapsed()
print("⏱️ 処理時間: \(elapsedSeconds)秒")
```

**方法2: 手動計測**

1. iPhoneの「ストップウォッチ」アプリを起動
2. 文字起こし開始と同時にスタート
3. 完了時にストップ
4. 時間を記録

#### 記録する値

**テンプレート**:
```
音声長さ: 10分00秒
処理時間: 45秒
レイテンシ比: 0.075（処理時間 ÷ 音声長さ）
```

**レイテンシ比の目安**:
- **0.05以下**: 非常に高速（リアルタイム性高）
- **0.05-0.1**: 高速（実用的）
- **0.1-0.2**: 普通（許容範囲）
- **0.2以上**: 遅い（最適化が必要）

---

## 10分音声テストの記録テンプレート

### テンプレート（コピー&ペースト用）

以下のテンプレートをコピーし、Googleスプレッドシートまたはメモアプリに貼り付けて記録してください。

```markdown
# iOS版GaQ Transcriber 性能計測結果

## テスト環境

| 項目 | 値 |
|------|-----|
| **日付** | 2025-10-XX |
| **デバイス** | iPhone XX |
| **iOSバージョン** | iOS XX.X |
| **モデル** | Base / Small / Tiny（選択） |
| **音声ファイル** | sample_10min.m4a |
| **音声長さ** | 10分00秒 |
| **バッテリー残量（開始時）** | XX% |

## 計測結果

### 1. レイテンシ（処理時間）

| 項目 | 値 |
|------|-----|
| **処理時間** | XX秒 |
| **レイテンシ比** | 0.XXX（処理時間 ÷ 600秒） |
| **判定** | ✅ 合格 / ⚠️ 注意 / ❌ 不合格 |

### 2. CPU使用率

| 項目 | 値 |
|------|-----|
| **平均CPU使用率** | XX% |
| **ピークCPU使用率** | XX% |
| **判定** | ✅ 合格 / ⚠️ 注意 / ❌ 不合格 |

### 3. メモリ使用量

| 項目 | 値 |
|------|-----|
| **ピークメモリ** | XXXMB |
| **平均メモリ** | XXXMB |
| **メモリリーク** | なし / あり |
| **判定** | ✅ 合格 / ⚠️ 注意 / ❌ 不合格 |

### 4. エネルギー消費

| 項目 | 値 |
|------|-----|
| **Energy Impact** | Low / Medium / High |
| **バッテリー消費** | XX%（開始時 - 終了時） |
| **判定** | ✅ 合格 / ⚠️ 注意 / ❌ 不合格 |

### 5. 発熱

| 項目 | 値 |
|------|-----|
| **発熱レベル** | 冷たい / 温かい / 熱い / 非常に熱い |
| **コメント** | （自由記述） |
| **判定** | ✅ 合格 / ⚠️ 注意 / ❌ 不合格 |

## 総合評価

| 項目 | 判定 |
|------|------|
| **レイテンシ** | ✅ / ⚠️ / ❌ |
| **CPU使用率** | ✅ / ⚠️ / ❌ |
| **メモリ使用量** | ✅ / ⚠️ / ❌ |
| **エネルギー消費** | ✅ / ⚠️ / ❌ |
| **発熱** | ✅ / ⚠️ / ❌ |

**総合判定**: ✅ 合格 / ⚠️ 要改善 / ❌ 不合格

## コメント・所感

（自由記述）
例:
- 処理速度は実用的だが、発熱が気になる
- メモリ使用量が予想より少なく、良好
- UIの反応が良く、ユーザー体験は問題なし

## スクリーンショット

- CPU使用率: `cpu_base_10min_iphone14.png`
- メモリ使用量: `memory_base_10min_iphone14.png`
- エネルギー消費: `energy_base_10min_iphone14.png`
```

---

## 計測結果の共有形式

### Googleスプレッドシートでの管理（推奨）

**作成方法**:
1. Googleスプレッドシートを新規作成
2. シート名: 「iOS版GaQ 性能計測」
3. 列見出し:
   ```
   | 日付 | デバイス | モデル | 処理時間 | CPU平均 | メモリピーク | Energy | 発熱 | 総合判定 | コメント |
   ```

**記入例**:
```
| 2025-10-25 | iPhone 14 | Base | 45秒 | 48% | 520MB | Medium | 温かい | ✅ 合格 | 実用的 |
| 2025-10-26 | iPhone 14 | Small | 60秒 | 55% | 680MB | High | 熱い | ⚠️ 要改善 | 発熱注意 |
```

### Markdownファイルでの管理

**ファイル名**: `measurement_results_YYYYMMDD.md`

**保存先**: `docs/ios_phase1/measurement_results/`

**共有方法**:
1. Markdownファイルを作成
2. GitHubにコミット・プッシュ
3. Codex/Claude Codeと共有

---

## トラブルシューティング

### Q1: Instrumentsが起動しない

**症状**: 「Product」→「Profile」が選択できない

**原因**: ビルドスキームが正しく設定されていない

**対処方法**:
1. Xcodeで「**Product**」→「**Scheme**」→「**Edit Scheme...**」
2. 左メニューから「**Profile**」を選択
3. 「**Build Configuration**」を「**Release**」に設定
4. 「**Close**」をクリック

---

### Q2: 「No instruments available」エラー

**症状**: Instrumentsが起動するが、計測できない

**原因**: Command Line Toolsが設定されていない

**対処方法**:
1. Xcodeの「**Settings...**」（`⌘,`）
2. 「**Locations**」タブ
3. 「**Command Line Tools**」で最新版を選択

---

### Q3: メモリ使用量が異常に高い

**症状**: ピークメモリが1GB以上

**原因**: メモリリーク、または大きすぎるモデル

**対処方法**:
1. より小さいモデル（Tiny / Base）で再テスト
2. Allocations Instrumentsで詳細分析
3. コードのメモリリーク箇所を特定

---

### Q4: 発熱がひどく、計測が完了しない

**症状**: iPhoneが過熱し、処理が途中で停止

**原因**: 長時間連続処理、または環境温度が高い

**対処方法**:
1. iPhoneを冷ます（5-10分）
2. エアコンで室温を下げる
3. より軽量なモデル（Tiny）で再テスト
4. 音声を短く（5分）して再テスト

---

## ✅ 計測完了チェックリスト

以下がすべて✅になれば、Phase 1の性能計測は完了です！

- [ ] CPU使用率を計測（Time Profiler）
- [ ] メモリ使用量を計測（Allocations）
- [ ] エネルギー消費を計測（Energy Log）
- [ ] 発熱を評価（主観評価）
- [ ] レイテンシを計測（処理時間）
- [ ] 記録テンプレートに結果を記入
- [ ] スクリーンショットを保存
- [ ] 結果をCodex/Claude Codeと共有

---

## 📚 次のステップ

計測完了後は、以下に進んでください：

1. **結果の分析** - Codexと共有し、モデル選定を決定
2. **Phase 2開始** - SwiftUI実装（別途ガイド提供）

---

**最終更新**: 2025-10-23
**作成**: Claude Code
**レビュー**: Codex（予定）
